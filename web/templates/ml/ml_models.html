{% extends "base.html" %}

{% block title %}SCEF - ML Models{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>ML Models</h1>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModelModal">
            <i class="bi bi-plus-circle"></i> Create Model
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Available Models</h5>
            </div>
            <div class="card-body">
                <div id="models-list" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="models-table-body">
                            <!-- Models will be loaded here -->
                            <tr>
                                <td colspan="5" class="text-center">Loading models...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Model Modal -->
<div class="modal fade" id="createModelModal" tabindex="-1" aria-labelledby="createModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModelModalLabel">Create ML Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createModelForm">
                    <div class="mb-3">
                        <label for="model-type" class="form-label">Model Type</label>
                        <select class="form-control" id="model-type" name="model_type" required>
                            <option value="">Select model type...</option>
                            <option value="classifier">Classifier</option>
                            <option value="regressor">Regressor</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="model-name" class="form-label">Model Algorithm</label>
                        <select class="form-control" id="model-name" name="model_name" required>
                            <option value="">Select algorithm...</option>
                            <optgroup label="Classifiers" id="classifier-options">
                                <option value="random_forest">Random Forest</option>
                                <option value="logistic_regression">Logistic Regression</option>
                                <option value="svm">Support Vector Machine</option>
                            </optgroup>
                            <optgroup label="Regressors" id="regressor-options">
                                <option value="random_forest">Random Forest</option>
                                <option value="linear_regression">Linear Regression</option>
                                <option value="svm">Support Vector Regression</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="prediction-horizon" class="form-label">Prediction Horizon</label>
                        <input type="number" class="form-control" id="prediction-horizon" name="prediction_horizon" value="1" min="1" max="20" required>
                        <div class="form-text">Number of periods ahead to predict.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="create-model-btn">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Train Model Modal -->
<div class="modal fade" id="trainModelModal" tabindex="-1" aria-labelledby="trainModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trainModelModalLabel">Train Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="trainModelForm">
                    <input type="hidden" id="train-model-id" name="model_id">
                    
                    <div class="mb-3">
                        <label for="data-select" class="form-label">Market Data</label>
                        <select class="form-control" id="data-select" name="data_id" required>
                            <option value="">Select market data...</option>
                            <!-- Market data will be loaded here -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="train-test-split" class="form-label">Train/Test Split</label>
                        <input type="range" class="form-range" id="train-test-split" name="train_test_split" min="0.5" max="0.9" step="0.05" value="0.7">
                        <div class="d-flex justify-content-between">
                            <span>50% Train</span>
                            <span id="split-value">70% Train</span>
                            <span>90% Train</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="train-model-btn">Train</button>
            </div>
        </div>
    </div>
</div>

<!-- Model Details Modal -->
<div class="modal fade" id="modelDetailsModal" tabindex="-1" aria-labelledby="modelDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modelDetailsModalLabel">Model Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="model-details-content">
                    <!-- Model details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="create-strategy-btn">Create Strategy</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load models
        loadModels();
        
        // Load market data for training
        loadMarketData();
        
        // Initialize modals
        const createModelModal = new bootstrap.Modal(document.getElementById('createModelModal'));
        const trainModelModal = new bootstrap.Modal(document.getElementById('trainModelModal'));
        const modelDetailsModal = new bootstrap.Modal(document.getElementById('modelDetailsModal'));
        
        // Handle model type selection
        document.getElementById('model-type').addEventListener('change', function() {
            const modelType = this.value;
            
            // Show/hide algorithm options based on model type
            document.querySelectorAll('#model-name optgroup').forEach(function(optgroup) {
                optgroup.style.display = 'none';
            });
            
            if (modelType === 'classifier') {
                document.getElementById('classifier-options').style.display = 'block';
            } else if (modelType === 'regressor') {
                document.getElementById('regressor-options').style.display = 'block';
            }
            
            // Reset model name selection
            document.getElementById('model-name').value = '';
        });
        
        // Handle train/test split slider
        document.getElementById('train-test-split').addEventListener('input', function() {
            const value = this.value;
            document.getElementById('split-value').textContent = `${Math.round(value * 100)}% Train`;
        });
        
        // Create model button
        document.getElementById('create-model-btn').addEventListener('click', createModel);
        
        // Train model button
        document.getElementById('train-model-btn').addEventListener('click', trainModel);
    });
    
    function loadModels() {
        fetch('/api/ml/models')
            .then(response => response.json())
            .then(models => {
                const tableBody = document.getElementById('models-table-body');
                
                if (models.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No models found. Create your first model!</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = '';
                
                models.forEach(model => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${model.model_name || model.id.substring(0, 8)}</td>
                        <td>${model.model_type}</td>
                        <td>${model.is_trained ? '<span class="badge bg-success">Trained</span>' : '<span class="badge bg-warning">Not Trained</span>'}</td>
                        <td>${new Date(model.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary view-model-btn" data-model-id="${model.id}">View</button>
                            <button class="btn btn-sm btn-outline-success train-model-btn" data-model-id="${model.id}" ${model.is_trained ? 'disabled' : ''}>Train</button>
                            <button class="btn btn-sm btn-outline-danger create-strategy-from-model-btn" data-model-id="${model.id}" ${!model.is_trained ? 'disabled' : ''}>Create Strategy</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.view-model-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const modelId = this.getAttribute('data-model-id');
                        viewModel(modelId);
                    });
                });
                
                document.querySelectorAll('.train-model-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const modelId = this.getAttribute('data-model-id');
                        openTrainModelModal(modelId);
                    });
                });
                
                document.querySelectorAll('.create-strategy-from-model-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const modelId = this.getAttribute('data-model-id');
                        createStrategyFromModel(modelId);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading models:', error);
                document.getElementById('models-table-body').innerHTML = 
                    `<tr><td colspan="5" class="text-center text-danger">Error loading models: ${error}</td></tr>`;
            });
    }
    
    function loadMarketData() {
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                const selectElement = document.getElementById('data-select');
                
                // Keep the first option (placeholder)
                const placeholder = selectElement.options[0];
                selectElement.innerHTML = '';
                selectElement.appendChild(placeholder);
                
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    selectElement.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading market data:', error);
                showToast('Error loading market data: ' + error, 'danger');
            });
    }
    
    function createModel() {
        const form = document.getElementById('createModelForm');
        
        // Validate form
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Get form values
        const modelType = document.getElementById('model-type').value;
        const modelName = document.getElementById('model-name').value;
        const predictionHorizon = parseInt(document.getElementById('prediction-horizon').value);
        
        // Create model config
        const modelConfig = {
            model_type: modelType,
            model_name: modelName,
            prediction_horizon: predictionHorizon
        };
        
        // Send request to create model
        fetch('/api/ml/models', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(modelConfig)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                showToast('Model created successfully!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createModelModal'));
                modal.hide();
                
                // Reset form
                form.reset();
                
                // Reload models
                loadModels();
                
                // Open train modal for the new model
                openTrainModelModal(data.model_id);
            } else {
                showToast('Error creating model: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error creating model:', error);
            showToast('Error creating model: ' + error, 'danger');
        });
    }
    
    function openTrainModelModal(modelId) {
        // Set model ID in form
        document.getElementById('train-model-id').value = modelId;
        
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('trainModelModal'));
        modal.show();
    }
    
    function trainModel() {
        const form = document.getElementById('trainModelForm');
        
        // Validate form
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Get form values
        const modelId = document.getElementById('train-model-id').value;
        const dataId = document.getElementById('data-select').value;
        const trainTestSplit = parseFloat(document.getElementById('train-test-split').value);
        
        // Create request data
        const requestData = {
            model_id: modelId,
            data_id: dataId,
            train_test_split: trainTestSplit,
            model_config: null, // Not needed since we're using an existing model
            feature_params: {
                windows: [5, 10, 20, 50],
                include_time_features: true,
                lookback: 1,
                normalization_method: "z_score"
            }
        };
        
        // Disable button and show loading state
        const button = document.getElementById('train-model-btn');
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Training...';
        
        // Send request to train model
        fetch('/api/ml/models/train', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                showToast('Model trained successfully!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('trainModelModal'));
                modal.hide();
                
                // Reset form
                form.reset();
                
                // Reload models
                loadModels();
                
                // Show model details
                viewModel(modelId);
            } else {
                showToast('Error training model: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error training model:', error);
            showToast('Error training model: ' + error, 'danger');
        })
        .finally(() => {
            // Reset button
            button.disabled = false;
            button.innerHTML = 'Train';
        });
    }
    
    function viewModel(modelId) {
        fetch(`/api/ml/models/${modelId}`)
            .then(response => response.json())
            .then(model => {
                const detailsContainer = document.getElementById('model-details-content');
                
                detailsContainer.innerHTML = `
                    <div class="mb-3">
                        <h4>${model.config.model_name} ${model.config.model_type}</h4>
                        <p><strong>Status:</strong> ${model.is_trained ? '<span class="badge bg-success">Trained</span>' : '<span class="badge bg-warning">Not Trained</span>'}</p>
                        <p><strong>Created:</strong> ${new Date(model.created_at).toLocaleString()}</p>
                        <p><strong>Prediction Horizon:</strong> ${model.config.prediction_horizon} periods</p>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Model Configuration</h5>
                        <pre class="bg-light p-3 rounded">${JSON.stringify(model.config, null, 2)}</pre>
                    </div>
                `;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('modelDetailsModal'));
                modal.show();
                
                // Update create strategy button
                const createStrategyBtn = document.getElementById('create-strategy-btn');
                createStrategyBtn.disabled = !model.is_trained;
                createStrategyBtn.onclick = function() {
                    createStrategyFromModel(modelId);
                    modal.hide();
                };
            })
            .catch(error => {
                console.error('Error loading model details:', error);
                showToast('Error loading model details: ' + error, 'danger');
            });
    }
    
    function createStrategyFromModel(modelId) {
        // Redirect to ML strategies page with model ID
        window.location.href = `/ml/strategies?model=${modelId}`;
    }
</script>
{% endblock %}
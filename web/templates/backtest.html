{% extends "base.html" %}

{% block title %}SCEF - Backtest{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Backtesting</h1>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Run Backtest</h5>
            </div>
            <div class="card-body">
                <form id="backtest-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="strategy-select" class="form-label">Strategy</label>
                            <select class="form-control" id="strategy-select" required>
                                <option value="">Select a strategy...</option>
                                <!-- Strategies will be loaded here -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="data-select" class="form-label">Market Data</label>
                            <select class="form-control" id="data-select" required>
                                <option value="">Select market data...</option>
                                <!-- Market data will be loaded here -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" id="run-backtest-btn">Run Backtest</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Backtest Results</h5>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="export-results-btn" disabled>Export Results</button>
                    <button type="button" class="btn btn-sm btn-outline-danger" id="deploy-strategy-btn" disabled>Deploy Strategy</button>
                </div>
            </div>
            <div class="card-body">
                <div id="backtest-results">
                    <!-- Results will be displayed here -->
                    <div class="text-center text-muted py-5">
                        <p>Run a backtest to see results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backtest Settings Modal -->
<div class="modal fade" id="backtestSettingsModal" tabindex="-1" aria-labelledby="backtestSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backtestSettingsModalLabel">Backtest Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="backtest-settings-form">
                    <div class="mb-3">
                        <label for="starting-capital" class="form-label">Starting Capital</label>
                        <input type="number" class="form-control" id="starting-capital" value="100000" min="1000">
                    </div>
                    <div class="mb-3">
                        <label for="commission-rate" class="form-label">Commission Rate</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="commission-rate" value="0.1" min="0" step="0.01">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="slippage-model" class="form-label">Slippage Model</label>
                        <select class="form-control" id="slippage-model">
                            <option value="percentage">Percentage</option>
                            <option value="fixed">Fixed</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="slippage-value" class="form-label">Slippage Value</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="slippage-value" value="0.05" min="0" step="0.01">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="track-trades" checked>
                        <label class="form-check-label" for="track-trades">Track Trade History</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="apply-settings-btn">Apply Settings</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentBacktestResultId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Load strategies and market data
        loadStrategies();
        loadMarketData();
        
        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const strategyId = urlParams.get('strategy');
        const dataId = urlParams.get('data');
        const resultId = urlParams.get('result');
        
        if (strategyId) {
            document.getElementById('strategy-select').value = strategyId;
        }
        
        if (dataId) {
            document.getElementById('data-select').value = dataId;
        }
        
        if (resultId) {
            loadBacktestResult(resultId);
        }
        
        // Run backtest button
        document.getElementById('run-backtest-btn').addEventListener('click', function() {
            const settingsModal = new bootstrap.Modal(document.getElementById('backtestSettingsModal'));
            settingsModal.show();
        });
        
        // Apply settings button
        document.getElementById('apply-settings-btn').addEventListener('click', function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('backtestSettingsModal'));
            modal.hide();
            runBacktest();
        });
        
        // Export results button
        document.getElementById('export-results-btn').addEventListener('click', function() {
            if (!currentBacktestResultId) {
                showToast('No backtest results to export', 'warning');
                return;
            }
            
            // TODO: Implement export functionality
            alert('Export functionality not implemented yet');
        });
        
        // Deploy strategy button
        document.getElementById('deploy-strategy-btn').addEventListener('click', function() {
            if (!currentBacktestResultId) {
                showToast('Run a backtest first', 'warning');
                return;
            }
            
            const strategyId = document.getElementById('strategy-select').value;
            const dataId = document.getElementById('data-select').value;
            
            window.location.href = `/deploy?strategy=${strategyId}&data=${dataId}&result=${currentBacktestResultId}`;
        });
    });
    
    function loadStrategies() {
        fetch('/api/strategies')
            .then(response => response.json())
            .then(strategies => {
                const selectElement = document.getElementById('strategy-select');
                
                // Keep the first option (placeholder)
                const placeholder = selectElement.options[0];
                selectElement.innerHTML = '';
                selectElement.appendChild(placeholder);
                
                strategies.forEach(strategy => {
                    const option = document.createElement('option');
                    option.value = strategy.id;
                    option.textContent = strategy.name;
                    selectElement.appendChild(option);
                });
                
                // Check if a strategy was specified in the URL
                const urlParams = new URLSearchParams(window.location.search);
                const strategyId = urlParams.get('strategy');
                
                if (strategyId) {
                    selectElement.value = strategyId;
                }
            })
            .catch(error => {
                console.error('Error loading strategies:', error);
                showToast('Error loading strategies: ' + error, 'danger');
            });
    }
    
    function loadMarketData() {
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                const selectElement = document.getElementById('data-select');
                
                // Keep the first option (placeholder)
                const placeholder = selectElement.options[0];
                selectElement.innerHTML = '';
                selectElement.appendChild(placeholder);
                
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    selectElement.appendChild(option);
                });
                
                // Check if data was specified in the URL
                const urlParams = new URLSearchParams(window.location.search);
                const dataId = urlParams.get('data');
                
                if (dataId) {
                    selectElement.value = dataId;
                }
            })
            .catch(error => {
                console.error('Error loading market data:', error);
                showToast('Error loading market data: ' + error, 'danger');
            });
    }
    
    function runBacktest() {
        const strategyId = document.getElementById('strategy-select').value;
        const dataId = document.getElementById('data-select').value;
        
        // Validate selections
        if (!strategyId) {
            showToast('Please select a strategy', 'warning');
            return;
        }
        
        if (!dataId) {
            showToast('Please select market data', 'warning');
            return;
        }
        
        // Get backtest settings
        const settings = {
            starting_capital: parseFloat(document.getElementById('starting-capital').value),
            commission_rate: parseFloat(document.getElementById('commission-rate').value) / 100, // Convert percentage to decimal
            slippage_model: document.getElementById('slippage-model').value,
            slippage_value: parseFloat(document.getElementById('slippage-value').value) / 100, // Convert percentage to decimal
            track_trade_history: document.getElementById('track-trades').checked,
            track_positions_history: true,
            track_capital_history: true
        };
        
        // Show loading indicator
        document.getElementById('backtest-results').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Running backtest...</p>
            </div>
        `;
        
        // Run backtest
        fetch('/api/backtest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                strategy_id: strategyId,
                data_id: dataId,
                config: settings
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Store result ID
                currentBacktestResultId = data.result_id;
                
                // Enable buttons
                document.getElementById('export-results-btn').disabled = false;
                document.getElementById('deploy-strategy-btn').disabled = false;
                
                // Display results
                displayBacktestResults(data);
                
                // Update URL with result ID
                const url = new URL(window.location.href);
                url.searchParams.set('result', data.result_id);
                window.history.replaceState({}, '', url);
                
                // Show success message
                showToast('Backtest completed successfully!', 'success');
            } else {
                showToast('Error running backtest: ' + (data.message || 'Unknown error'), 'danger');
                
                // Reset results container
                document.getElementById('backtest-results').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <p>Run a backtest to see results</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error running backtest:', error);
            showToast('Error running backtest: ' + error, 'danger');
            
            // Reset results container
            document.getElementById('backtest-results').innerHTML = `
                <div class="text-center text-muted py-5">
                    <p>Run a backtest to see results</p>
                </div>
            `;
        });
    }
    
    function loadBacktestResult(resultId) {
        fetch(`/api/backtest/${resultId}`)
            .then(response => response.json())
            .then(data => {
                // Store result ID
                currentBacktestResultId = resultId;
                
                // Enable buttons
                document.getElementById('export-results-btn').disabled = false;
                document.getElementById('deploy-strategy-btn').disabled = false;
                
                // Set strategy and data selects
                document.getElementById('strategy-select').value = data.strategy_id;
                document.getElementById('data-select').value = data.data_id;
                
                // Display results
                displayBacktestResults(data);
                
                // Show message
                showToast('Backtest results loaded', 'info');
            })
            .catch(error => {
                console.error('Error loading backtest result:', error);
                showToast('Error loading backtest result: ' + error, 'danger');
            });
    }
    
    function displayBacktestResults(data) {
        const resultsContainer = document.getElementById('backtest-results');
        
        // Format metrics
        const metricsHtml = formatBacktestMetrics(data.metrics);
        
        // Create results HTML
        resultsContainer.innerHTML = `
            <div class="backtest-metrics mb-4">
                ${metricsHtml}
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-4">
                    <h5>Equity Curve</h5>
                    <div class="plot-container">
                        <img src="${data.plots.equity_curve}" class="img-fluid" alt="Equity Curve">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-4">
                    <h5>Positions Over Time</h5>
                    <div class="plot-container">
                        <img src="${data.plots.positions}" class="img-fluid" alt="Positions">
                    </div>
                </div>
            </div>
        `;
    }
</script>
{% endblock %}

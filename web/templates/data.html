{% extends "base.html" %}

{% block title %}SCEF - Market Data{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Market Data</h1>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDataModal">
            <i class="bi bi-upload"></i> Upload Data
        </button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createSampleDataModal">
            <i class="bi bi-plus-circle"></i> Create Sample Data
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Available Market Data</h5>
            </div>
            <div class="card-body">
                <div id="data-list" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Date Range</th>
                                <th>Rows</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                            <!-- Data will be loaded here -->
                            <tr>
                                <td colspan="4" class="text-center">Loading market data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Data Modal -->
<div class="modal fade" id="uploadDataModal" tabindex="-1" aria-labelledby="uploadDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadDataModalLabel">Upload Market Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadDataForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="data-name" class="form-label">Data Name</label>
                        <input type="text" class="form-control" id="data-name" name="data_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="data-file" class="form-label">Data File</label>
                        <input type="file" class="form-control" id="data-file" name="data_file" required accept=".csv,.parquet">
                        <div class="form-text">Upload a CSV or Parquet file with OHLCV data.</div>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <p><strong>Required columns:</strong> open, high, low, close, volume</p>
                            <p><strong>Expected format:</strong> The first column should be the date/time index.</p>
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="upload-data-btn">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Sample Data Modal -->
<div class="modal fade" id="createSampleDataModal" tabindex="-1" aria-labelledby="createSampleDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createSampleDataModalLabel">Create Sample Market Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createSampleDataForm">
                    <div class="mb-3">
                        <label for="sample-days" class="form-label">Number of Days</label>
                        <input type="number" class="form-control" id="sample-days" value="500" min="10" max="1000">
                    </div>
                    <div class="mb-3">
                        <label for="sample-volatility" class="form-label">Volatility</label>
                        <input type="number" class="form-control" id="sample-volatility" value="0.01" min="0.001" max="0.1" step="0.001">
                        <div class="form-text">Higher values create more volatile price movements.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="create-sample-data-btn">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Data Preview Modal -->
<div class="modal fade" id="dataPreviewModal" tabindex="-1" aria-labelledby="dataPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dataPreviewModalLabel">Data Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="data-preview-content">
                    <!-- Data preview will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="use-for-backtest-btn">Use for Backtest</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load all market data
        loadMarketData();
        
        // Upload data
        document.getElementById('upload-data-btn').addEventListener('click', uploadData);
        
        // Create sample data
        document.getElementById('create-sample-data-btn').addEventListener('click', createSampleData);
    });
    
    function loadMarketData() {
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('data-table-body');
                
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No market data found. Upload data or create sample data.</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = '';
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.date_range || 'N/A'}</td>
                        <td>${item.num_rows || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary preview-data-btn" data-data-id="${item.id}">Preview</button>
                            <button class="btn btn-sm btn-outline-success use-for-backtest-btn" data-data-id="${item.id}">Use for Backtest</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.preview-data-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const dataId = this.getAttribute('data-data-id');
                        previewData(dataId);
                    });
                });
                
                document.querySelectorAll('.use-for-backtest-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const dataId = this.getAttribute('data-data-id');
                        window.location.href = `/backtest?data=${dataId}`;
                    });
                });
            })
            .catch(error => {
                console.error('Error loading market data:', error);
                document.getElementById('data-table-body').innerHTML = 
                    `<tr><td colspan="4" class="text-center text-danger">Error loading market data: ${error}</td></tr>`;
            });
    }
    
    function uploadData() {
        const form = document.getElementById('uploadDataForm');
        const formData = new FormData(form);
        
        // Validate form
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Disable button and show loading state
        const button = document.getElementById('upload-data-btn');
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
        
        fetch('/api/data/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                showToast('Market data uploaded successfully!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('uploadDataModal'));
                modal.hide();
                
                // Reset form
                form.reset();
                
                // Reload market data
                loadMarketData();
            } else {
                showToast('Error uploading market data: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error uploading market data:', error);
            showToast('Error uploading market data: ' + error, 'danger');
        })
        .finally(() => {
            // Reset button
            button.disabled = false;
            button.innerHTML = 'Upload';
        });
    }
    
    function createSampleData() {
        const days = document.getElementById('sample-days').value;
        const volatility = document.getElementById('sample-volatility').value;
        
        // Validate inputs
        if (!days || !volatility) {
            showToast('Please fill in all fields', 'warning');
            return;
        }
        
        // Disable button and show loading state
        const button = document.getElementById('create-sample-data-btn');
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
        
        fetch('/api/data/sample', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                days: parseInt(days),
                volatility: parseFloat(volatility)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                showToast('Sample market data created successfully!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('createSampleDataModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('createSampleDataForm').reset();
                
                // Reload market data
                loadMarketData();
            } else {
                showToast('Error creating sample market data: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error creating sample market data:', error);
            showToast('Error creating sample market data: ' + error, 'danger');
        })
        .finally(() => {
            // Reset button
            button.disabled = false;
            button.innerHTML = 'Create';
        });
    }
    
    function previewData(dataId) {
        // TODO: Implement data preview functionality
        // For now, just redirect to backtest page
        window.location.href = `/backtest?data=${dataId}`;
    }
</script>
{% endblock %}
